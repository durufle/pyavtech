default:
    image: python:3.8

variables:
    PIP_DIR: "/root/.pip"
    PIP_FILE: "/root/.pip/pip.conf"

stages:
    - build
    - deploy

before_script:
    - echo "Initialize environment"
    - apt-get update -qy
    - apt-get install -y python-dev python-pip
    - apt-get install -y python3-sphinx
    - 'mkdir $PIP_DIR'
    - 'touch $PIP_FILE'
    - 'echo [global] >> $PIP_FILE'
    - 'echo index-url = http://$DEVPI_HOST:3141/$DEVPI_INDEX/+simple/ >> $PIP_FILE'
    - 'echo [search] >> $PIP_FILE'
    - 'echo index = http://$DEVPI_HOST:3141/$DEVPI_INDEX/ >> $PIP_FILE'
    - 'echo [install] >> $PIP_FILE'
    - 'echo trusted-host = $DEVPI_HOST >> $PIP_FILE'
    - pip install -r requirements.txt

builds:
    stage: build
    script:
    - echo "Generate package and sphinx documentation"
    - python setup.py bdist_wheel build_sphinx
    artifacts:
        name: $CI_PROJECT_NAME-$CI_JOB_STAGE-$CI_JOB_ID-$CI_COMMIT_REF_NAME
        paths:
            - ./dist
            - ./build/sphinx/html

production:
    stage: deploy
    script:
    - echo "deploy phase"
    only:
    - tags
